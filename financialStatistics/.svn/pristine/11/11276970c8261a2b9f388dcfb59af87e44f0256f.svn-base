package com.ttmv.financialStatistics;

import java.io.IOException;
import java.util.Date;

import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.fs.FileSystem;
import org.apache.hadoop.fs.Path;
import org.apache.hadoop.io.Text;
import org.apache.hadoop.mapreduce.Job;
import org.apache.hadoop.mapreduce.lib.input.FileInputFormat;
import org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;
import org.apache.hadoop.mapreduce.lib.output.MultipleOutputs;
import org.apache.hadoop.mapreduce.lib.output.TextOutputFormat;
import org.apache.log4j.LogManager;
import org.apache.log4j.Logger;

/***
 * 执行mr的入口
 * 
 * @author kate
 *
 */
public class Main {
	private static Logger logger = LogManager.getLogger(Main.class);
	public static void main(String[] args) {
		Configuration conf = new Configuration();
		Path outPath = new Path(args[1]);
		FileSystem fs;
		try {
			fs = FileSystem.get(conf);
			// 如果输出路径已存在，则先删除
			if (fs.exists(outPath)) {
				fs.delete(outPath, true);
				logger.info(outPath + "输出路径存在，已删除！");
				fs.close();
			}
		} catch (IOException e) {
			logger.error("hdfs 删除文件路径失败，失败的原因是:",e);
		}
		Job job = null;
		try {
			job = Job.getInstance(conf, "AllDataStatistic");
			job.setJarByClass(Main.class);
			job.setMapperClass(DataStatisticsMap.class);
			job.setCombinerClass(DataStatisticReducer.class);
			job.setReducerClass(DataStatisticReducer.class);
			job.setOutputKeyClass(Text.class);
			job.setOutputValueClass(Text.class);
			FileInputFormat.addInputPath(job, new Path(args[0]));
			FileOutputFormat.setOutputPath(job, new Path(args[1]));
			MultipleOutputs.addNamedOutput(job, "AllDataStatistic", TextOutputFormat.class, Text.class, Text.class);
			DataEntity dataEntity=new DataEntity();
			dataEntity.setStatisticDay(DateUtil.getQueryFixedTime(new Date(), 1, -1));;
			dataEntity.setOutputPath(args[1]);
			if (job.waitForCompletion(true)) {
				RedisUtil.pushDataToRedisQueue("dams_statistic_finish", JsonUtil.getObjectToJson(dataEntity));
				System.exit(0);
			}else{
				System.exit(1);
			}
			
		} catch (Exception e) {
			logger.error("job 提交失败，失败的原因是:",e);
		}

	}

}
